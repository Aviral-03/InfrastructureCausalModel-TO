---
title: "Who Gets What: How Population and Income Shape Toronto’s Budget Decisions"
subtitle: "Understanding the Impact of Demographics and Economic Factors on City Spending Across 25 Wards"
author: 
  - Aviral Bhardwaj
thanks: "Code and data are available at: https://github.com/Aviral-03/Toronto-WardWide-Budget-Analysis"
date: today
date-format: long
abstract: "This study investigates how population density and average household income affect budget allocations across Toronto’s 25 wards. Using data from the city's 2023-2032 Capital Budget Plan and 2021 Ward Profiles, we analyze spending patterns in key areas like health and safety, infrastructure, and community services. Our findings reveal that higher population densities do not guarantee proportionally greater investments in essential services, while wealthier wards often receive larger capital expenditures. These insights highlight potential disparities in resource distribution, emphasizing the need for more equitable urban budget planning to address diverse community needs."
format: pdf
number-sections: true
toc: true
bibliography: references.bib
prefer-html: true
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(opendatatoronto)
library(readxl)
library(styler)
library(dplyr)
library(arrow)
library(ggrepel)
library(knitr)
library(kableExtra)
library(patchwork)
library(sf)
library(lintr)
library(DiagrammeR)
library(rsvg)
library(magrittr)
library(DiagrammeRsvg)
library(png)
library(webshot2)
library(gridExtra)
```

```{r}
#| include: false
#| warning: false
#| message: false

# Get the analysis data
analysis_budget_data <- read.csv(here::here("data/02-analysis_data/analysis_budget_data.csv"))
analysis_building_permits <- read.csv(here::here("data/02-analysis_data/analysis_building_permits.csv"))
analysis_ward_data <- read.csv(here::here("data/02-analysis_data/analysis_ward_data.csv"))


# Get Model
# model <- readRDS(here::here("models/model.rds"))
```

# Introduction {#sec-intro}

# Data {#sec-data}

The raw data was sourced from the City of Toronto's Open Data Portal using the `opendatatoronto` [@openDataToronto] package. For the purpose of this analysis we used several data sets: `2023 Ward Profiles (25-Ward Model)` [@toronto_ward_profiles], `Capital Budget and Plan Details from 2021-2024` [@toronto_budget_plan], `City Wards` [@toronto_city_wards], and `Building Permits - Active Permits` [@toronto_building_permits].

The data, provided in CSV formats, was cleaned and analyzed using R [@citeR] programming language. The `readxl` [@readxl] package was used for reading Excel files. Other R packages used which includes `tidyverse` [@tidyverse], `styler` [@styler], and `dplyr` [@dplyr] for creating tables. The `ggplot2` [@ggplot2] and `kableExtra` [@kableExtra] were used for data visualization and table formatting. The `patchwork` [@patchwork] package was used for combining multiple plots, and `sf` [@sf] for spatial data analysis. For models, we used `rstan` [@rstan] was used for fitting the model, and `modelsummary` [@modelsummary] for model summary tables. The `lintr` [@lintr] package was used for code linting. The `arrow` [@arrow] package was used for reading and writing Parquet files.

## Measurement

Our research question and estimand analyse the relationship between key demographic and economic factors—specifically, population and average household income—and the budget allocation across various categories in Toronto's 25 wards. Population is a critical demographic indicator, representing the number of residents in each ward, while average household income reflects economic well-being, influencing access to resources and quality of life [@Schaeffer]. Therefore, these two variables of interest were chosen for the analysis. Our primary aim is to estimate the impact of these variables on budget allocations for these specific categories of interest, specifically Growth-Related expenditures, State of Good Repair, and Service Improvement and Enhancement.

Population density is expected to affect the demand for services and infrastructure, while average household income may shape how resources are distributed across wards, reflecting broader economic disparities. The estimand is the causal effect of these factors on the allocation of funds, and the estimator will quantify how shifts in population and income levels influence budgetary decisions. By understanding this relationship, we aim to offer insights into how demographic and economic variables drive municipal spending patterns in different categories across the city. In order to better analyze the trends and modelling the data, we will use the Captial Budget and Plan Details from 2021-2024 datasets, comparing total 10-year budget allocations across different wards and categories of interest.

## Ward Profiles (25-Ward Model) {#sec-ward-profiles}

The 2021 Ward Profiles [@toronto_ward_profiles], based on the 25-Ward model were provided by City Planning. These profiles included census data from the 2021, 2016, and 2011 Census of Population, covering demographic, social, and economic information for each ward in Toronto. These variables were collected through methods including online responses, mailed questionnaires, the Census Help Line, and enumerators [@nhs_canada].

These questionnaires gathered information on various topics related to residents' demographic characteristics, such as education, household income, number of dependents, employment status and etc. Participation in the survey is voluntary, and data is collected directly from residents, including their postal codes, which are used to determine their respective wards. To ensure privacy and confidentiality, the data is subsequently aggregated and anonymized [@canada_statcan_2023_nhs].

This data-set was included in this analysis to provide insights into the population and average household income for each ward, providing insights into the city's socioeconomic landscape. 25-Ward model was used instead of the 44-Ward model as it was the most recent data available at the time of analysis and matched the Capital Budget data.

The data was stored in an Excel workbook with multiple tabs, but for this analysis, we used the first tab, `2021 Census One variable`, which contains data for all 25 wards (Ward 1, Ward 2, ..., Ward 25). After cleaning, the data was saved in CSV and Parquet formats, with the following columns:

-   `ward_id`: unique identifier for each ward,
-   `ward`: ward name,
-   `population`: total population,
-   `income`: average household income.

The ward names were manually entered into the cleaned data to match with `ward_id`. A sample of the data can be seen in [@tbl-ward-profile-data].

```{r}
#| echo: false
#| message: false
#| label: tbl-ward-profile-data
#| tbl-cap: Sample of Cleaned Toronto Ward Profile Data
#| tbl-pos: "h"

# Display the first few rows of the cleaned ward profile data using kable
analysis_ward_data |>
  head() |>
  kable(col.names = c("Ward ID", "Ward Name", "Population", "Income")) |>
  kable_styling(full_width = F, position = "center")
  
```

## Capital Budget and Plan Details {#sec-capital-budget}

Each year, the City of Toronto publishes the Capital Budget and Plan Details dataset [@toronto_budget_plan], which outlines a 10-year capital budget and plan. This dataset breaks down the capital budget across the city’s 25 wards, allocating funds for infrastructure projects, equipment purchases, and other fixed assets. This budget is developed through a collaborative process, where city staff prepare an initial draft, which is then reviewed by the Budget Committee. Input is solicited from Toronto residents and businesses, and subsequently, the Mayor presents the finalized budget proposal by February 1. City Council reviews and considers this budget within 30 days [@toronto_2024_budget].

For the purpose of this analysis we selected the year 2021-2024 to align with the 2022 municipal elections and the subsequent relevance to planning efforts. Furthermore, the city's budgeting process underwent significant shifts after 2020 due to the impact of the COVID-19 pandemic, which altered spending priorities and resource allocation. Focusing on the 2021–2024 timeframe allows us to analyze the post-pandemic period, avoiding the uncertainties of the pandemic and ensuring the data remains consistent and reliable.

Each budget plan includes five primary categories under `State of Good Repair`, `Growth Related`, `Health and Safety`, `Service Improvement and Enhancement`, and `Legislated`. These categories define the main areas where capital expenditures are directed. For this analysis, however, we will focus on these three variables of interest: `State of Good Repair`, `Growth Related`, and `Service Improvement and Enhancement`.

These categories were selected because they represent critical areas of investment that directly impact the quality of life and well-being of Toronto residents. `State of Good Repair` focuses on maintaining and preserving existing infrastructure, `Growth Related` addresses the expansion and development of new infrastructure, and `Service Improvement and Enhancement` aims to enhance public services and amenities. By analyzing budget allocations in these categories, we can gain valuable insights into the city's spending priorities and identify opportunities for more effective and equitable resource distribution. While also identifying potential disparities in funding across various wards of the city.

Raw data includes key columns such as `Project Name`, yearly budget allocations for each year, `Ward Number`, `Ward`, `Category`, and `Total 10 Year` (Sum of Year 1 to 10), where the budget is in thousands of dollars (e.g., 10 = \$10,000). [@tbl-capital-budget-data] shows a sample of the cleaned data along with our variables of interest:

-   `Ward ID`
-   `Ward Name`
-   `Category of the Capital Budget`
-   `Total 10-year capital budget` allocated to each ward

Rows with `CW` (city-wide budget) were removed since they were applicable to all wards.

```{r}
#| echo: false
#| message: false
#| label: tbl-capital-budget-data
#| tbl-cap: Sample of Cleaned Toronto Capital Budget Data
#| tbl-pos: "h"

analysis_budget_data |>
  head() |>
  select(ward_id, ward, category, total_10_year) |>
  kable(col.names = c("Ward ID", "Ward Name", "Category", 
                  "Total 10-Year Budget (in 000s)"))
```

## City Wards {#sec-ward-names}

The City Wards dataset [@toronto_city_wards], published by the City Clerk's Office and last updated on July 22, 2024, contains geographical information about each ward, including the ward ID, ward name, and ward boundary. These ward boundaries were decided as a part of `Bill 5, Better Local Government Act` in 2018, reducing the number of wards from 47 to 25 [@toronto_city_wards].

This dataset, effective January 1, 2024, was used to map the `ward_id` to the ward name in the cleaned data. Key columns include:

-   `ward_id`: unique identifier for each ward,
-   `ward`: ward name,
-   `ward_boundary`: geographical boundary of the ward.

The ward names were mapped to the `ward_id` and integrated with the Ward Profiles [@sec-ward-profiles] and Capital Budget data sets [@sec-capital-budget] to create the final data set for analysis. This dataset was not used directly in the analysis but was essential for mapping the ward names to the ward IDs in the cleaned data.

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-toronto-map-population
#| fig-cap: "Map of Toronto highlighting the population and income densities by ward"
#| fig.pos: 'H'
#| fig.height: 5

# URL to the zip file
url <- "https://ckan0.cf.opendata.inter.prod-toronto.ca/dataset/5e7a8234-f805-43ac-820f-03d7c360b588/resource/35f67d86-cfc8-4483-8d77-50d035b010d9/download/25-ward-model-december-2018-wgs84-latitude-longitude.zip"

# Temporary file to store the downloaded zip
temp_zip <- tempfile(fileext = ".zip")

# Download the zip file
download.file(url, temp_zip, mode = "wb")

# Unzip the file to a temporary directory
temp_dir <- tempdir()
unzip(temp_zip, exdir = temp_dir)

shapefiles <- list.files(temp_dir, pattern = "\\.shp$", full.names = TRUE)

toronto_map <- st_read(shapefiles[1], quiet = TRUE)

# Clean up the downloaded zip file
unlink(temp_zip)

# Merge analysis_data with toronto_map by ward_id
toronto_map <- merge(toronto_map, analysis_ward_data, 
                     by.x = "AREA_NAME", by.y = "ward") |>
  rename("income" = "average_household_income")

color_scale <- scale_fill_gradient(low = "lightblue", high = "darkblue")


# Plot with facet_wrap for average household income and population
plot1 <-ggplot() +
  geom_sf(data = toronto_map, aes(fill = population)) +
  geom_sf_text(data = toronto_map, aes(label = ward_id), 
               size = 2, color = "white") +
  color_scale +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "right")


plot2 <- ggplot() +
  geom_sf(data = toronto_map, aes(fill = income)) +
  geom_sf_text(data = toronto_map, aes(label = ward_id), size = 2, color = "white") +
  color_scale +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "right")

plot1 / plot2


```

## Building Permits - Active Permits {#sec-building-permits}

The *Building Permits - Active Permits* dataset [@toronto_building_permits], published by the City Planning Division and last updated on November 28, 2024, serves as a comprehensive record of active building permits in Toronto. A building permit is a municipally issued document, mandated by the Building Code Act and enforced by the City of Toronto, regulating the construction or demolition of physical structures [@toronto_building_permits].

The process of obtaining a building permit involves submitting an application to the City of Toronto, including necessary drawings, documents, and other forms based on the permit type. The Building Division reviews the application, and a Toronto Building Inspector ensures compliance with the Ontario Building Code, Zoning By-law, and other applicable regulations. Once approved, the permit is issued, allowing the applicant to commence construction or demolition.

Table [@tbl-raw-building-permits-data] outlines detailed information about active building permits in Toronto, including key features such as `Permit Number`, `Permit Type`, `Structure Type`, `Status`, and more.

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: tbl-raw-building-permits-data
#| tbl-cap: "Sample of the raw building permits data"
#| tbl-pos: "h"

# Load the raw building permits data
building_permits <- read_csv(here::here("data/01-raw_data/building_permits_data.csv"))

# Display the first few rows of the building permits data using kable
building_permits |>
  select("_id", PERMIT_TYPE, STRUCTURE_TYPE, WORK, POSTAL, STATUS) |>
  head() |>
  kable(col.names = c("ID", "Permit Type", "Structure Type", "Work", "Postal Code", "Status"))
```

We selected this data-set to evaluate how budget allocations correlate with the number of building permits issued in each ward. The number of permits serves as a proxy for construction activity and development, highlighting the demand for infrastructure investment and capital expenditures. By examining the relationship between building permits and budget allocations, we can gain valuable insights into how construction activity influences resource distribution across the city's wards.

From the raw data, we selected key variables of interest: `Postal Code`, `Status`, and `Work`. The `Postal Code` was used to map building permits to their respective wards, while `Status` and `Work` were utilized to filter permits based on their current state and type of work. [@tbl-status-building-permits-data] lists 45 unique statuses assigned to each submitted permit. For this analysis, we focused on permits with the following statuses: `Approved`, `Application Accepted`, `Issuance Pending`, `Ready for Issuance`, `Permit Issued`, and `Permit Issued/Close File`. These statuses indicate that the permit has been approved and that construction or demolition is either underway or completed.

To ensure we analyzed only construction-related permits, we filtered out entries where `Work` did not have the value `New Building`. The cleaned data was then saved in CSV and Parquet formats with the following columns:

-   **`ward_id`**: Unique identifier for each ward.\
-   **`total_building_permits`**: Total number of building permits issued in each ward.

[@fig-building-permits-data] illustrates the total number of building permits by ward, providing valuable insights into construction activity and development patterns across Toronto’s wards.

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-building-permits-data
#| fig-cap: "Total number of building permits by Ward"
#| fig-pos: "h"
#| fig-height: 5
#| fig-width: 10

# Display the total number of building permits by ward using kable
analysis_building_permits |>
  ggplot(aes(x = ward_id, y = total_building_permits)) +
  geom_histogram(stat = "identity", fill = "skyblue", color = "darkblue") +
  labs(x = "Ward ID", y = "Number of building permits") +
  scale_x_continuous(breaks = seq(1, 25, 1)) +
  # change the theme
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")
```

## Trends in Budget Allocations (2021-2024) {#sec-budget-trends}

```{r}
#| echo: false
#| warning: false
#| message: false

# select only growth related
growth_related <- analysis_budget_data |>
  filter(category == "Growth Related") |>
  mutate(total_10_year = total_10_year / 1000) |>
  # remove negative values
  filter(total_10_year > 0) |>
 rename(total_budget = total_10_year)

# Calculate the outliers using IQR
outliers <- growth_related |>
  group_by(year) |>
  mutate(
    Q1 = quantile(total_budget, 0.25),
    Q3 = quantile(total_budget, 0.75),
    IQR = Q3 - Q1,
    is_outlier = total_budget < (Q1 - 1.5 * IQR) | total_budget > (Q3 + 1.5 * IQR)
  ) |>
  filter(is_outlier)

# Plot with labels for outliers
plot1 <- ggplot(growth_related, aes(x = factor(year), y = total_budget)) +
  geom_boxplot(fill = "skyblue", color = "darkblue") +
  geom_jitter(aes(color = as.factor(ward_id)), width = 0.2) +
  geom_text(
    data = outliers, 
    aes(label = ward), 
    nudge_y = 15, 
    check_overlap = TRUE
  ) +  # Label only outliers
  labs(
    x = "Year",
    y = "Total Budget (in thousands)"
  ) +
  theme_minimal() +
  # remove legend
  theme(legend.position = "none")
```

```{r}
#| echo: false
#| warning: false
#| message: false

# select only growth related, state of good repair and service improvement and enhancement
state_of_good_repair <- analysis_budget_data |>
  filter(category == "State of Good Repair") |>
  mutate(total_10_year = total_10_year / 1000) |>
  # remove negative values
  filter(total_10_year > 0) |>
 rename(total_budget = total_10_year)

# Calculate the outliers using IQR
outliers <- state_of_good_repair |>
  group_by(year) |>
  mutate(
    Q1 = quantile(total_budget, 0.25),
    Q3 = quantile(total_budget, 0.75),
    IQR = Q3 - Q1,
    is_outlier = total_budget < (Q1 - 1.5 * IQR) | total_budget > (Q3 + 1.5 * IQR)
  ) |>
  filter(is_outlier)

# Plot with labels for outliers
plot2 <- ggplot(state_of_good_repair, aes(x = factor(year), y = total_budget)) +
  geom_boxplot(fill = "skyblue", color = "darkblue") +
  geom_jitter(aes(color = as.factor(ward_id)), width = 0.2) +
  geom_text(
    data = outliers, 
    aes(label = ward), 
    nudge_y = 15, 
    check_overlap = TRUE
  ) +  # Label only outliers
  labs(
    x = "Year",
    y = "Total Budget (in thousands)"
  ) +
  theme_minimal() +
  # remove legend
  theme(legend.position = "none")
```

```{r}
#| echo: false
#| warning: false
#| message: false
# select only growth related, state of good repair and service improvement and enhancement
service_improvement <- analysis_budget_data |>
  filter(category == "Service Improvement and Enhancement") |>
  mutate(total_10_year = total_10_year / 1000) |>
  # remove negative values
  filter(total_10_year > 0) |>
 rename(total_budget = total_10_year)

# Calculate the outliers using IQR
outliers <- service_improvement |>
  group_by(year) |>
  mutate(
    Q1 = quantile(total_budget, 0.25),
    Q3 = quantile(total_budget, 0.75),
    IQR = Q3 - Q1,
    is_outlier = total_budget < (Q1 - 1.5 * IQR) | total_budget > (Q3 + 1.5 * IQR)
  ) |>
  filter(is_outlier)

# Plot with labels for outliers
plot3 <- ggplot(service_improvement, aes(x = factor(year), y = total_budget)) +
  geom_boxplot(fill = "skyblue", color = "darkblue") +
  geom_jitter(aes(color = as.factor(ward_id)), width = 0.2) +
  geom_text(
    data = outliers, 
    aes(label = ward), 
    nudge_y = 15, 
    check_overlap = TRUE
  ) +  # Label only outliers
  labs(
    x = "Year",
    y = "Total Budget (in thousands)"
  ) +
  theme_minimal() +
  # remove legend
  theme(legend.position = "none")
```

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-budget-trends
#| fig.cap: "Trends in budget allocations (2021-2024) by category"
#| fig-subcap: ["Growth Related", "State of Good Repair", "Service Improvement and Enhancement"]
#| fig-pos: "h"
#| layout-ncol: 2

plot1
plot2
plot3
```


## Relationship between Population, Average Household Income, and Budget Allocations

Our budget data spans three categories—`Growth Related`, `State of Good Repair`, and `Service Improvement and Enhancement`—for the years 2021-2024. As observed in [@sec-budget-trends], there has been a steady increase in budget allocations across these categories. To better understand the relationship between these budget categories and our variables of interest, we calculate the average budget allocation for each category across the years. The results are presented in [@tbl-avg-budget-data].

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: tbl-avg-budget-data
#| tbl-cap: "Average 10-year budget allocations by category (2021-24)"
#| tbl-pos: "h"

# Calculate the average 10-year budget allocations by category
average_budget <- analysis_budget_data |>
  group_by(ward_id, ward, category) |>
  summarise(avg_total_10_year = mean(total_10_year)) |>
  pivot_wider(names_from = category, values_from = avg_total_10_year) |>
  select(ward_id, ward, `Growth Related`, `State of Good Repair`, `Service Improvement and Enhancement`)

average_budget |>
  head() |>
  kable(col.names = c("Ward ID", "Ward Name", "Growth Related", 
                      "State of Good Repair", "Service Improvement and Enhancement"))
```
### Relationship between Average Household Income & Population with Budget Allocation for Growth Related Projects and State of Good Repair Projects

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-growth-related-budget
#| fig.cap: "Growth Related Budget by Ward"
#| fig-pos: "h"
#| fig.width: 10
#| fig.height: 5

combined_data <- analysis_ward_data |>
  left_join(average_budget, by = "ward_id") |>
  left_join(analysis_building_permits, by = "ward_id") |>
  rename(ward = ward.x) |>
  select(ward_id, ward, population, average_household_income, `Growth Related`, `State of Good Repair`, `Service Improvement and Enhancement`, total_building_permits)

growth_budget <- combined_data |>
  select(ward_id, ward, population, average_household_income, `Growth Related`)

p1 <- ggplot(growth_budget, aes(x = population, y = `Growth Related`, label= ward_id)) +
  geom_point() +
  geom_text_repel(hjust = -0.5, vjust = 0.5) +
  geom_smooth(method = "lm", color = "blue", se = TRUE) +
  labs(x = "Population", y = "Average Total 10-Year Budget (in 000s) 2021-24") +
  theme_minimal()

p2 <- ggplot(growth_budget, aes(x = average_household_income, y = `Growth Related`, label= ward_id)) +
  geom_point() +
  geom_text_repel(hjust = -0.5, vjust = 0.5) +
  geom_smooth(method = "lm", color = "blue", se = TRUE) +
  labs(x = "Average Household Income", y = "") +
  theme_minimal()

# Combine both plots side by side
grid.arrange(p1, p2, ncol = 2)

```


```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-state-of-good-repair-budget
#| fig.cap: "State of Good Repair Budget by Ward"
#| fig-pos: "h"
#| fig.width: 10
#| fig.height: 5

good_repair_budget <- combined_data |>
  select(ward_id, ward, population, average_household_income, `State of Good Repair`)

p1 <- ggplot(good_repair_budget, aes(x = population, y = `State of Good Repair`, label= ward_id)) +
  geom_point() +
  geom_text_repel(hjust = -0.5, vjust = 0.5) +
  geom_smooth(method = "lm", color = "blue", se = TRUE) +
  labs(x = "Population", y = "Average Total 10-Year Budget (in 000s) 2021-24") +
  theme_minimal()

p2 <- ggplot(good_repair_budget, aes(x = average_household_income, y = `State of Good Repair`, label= ward_id)) +
  geom_point() +
  geom_text_repel(hjust = -0.5, vjust = 0.5) +
  geom_smooth(method = "lm", color = "blue", se = TRUE) +
  labs(x = "Average Household Income", y = "") +
  theme_minimal()

# Combine both plots side by side
grid.arrange(p1, p2, ncol = 2)
```
[@fig-growth-related-budget] illustrates the relationship between average household income, population, and the total 10-year budget allocation for Growth-Related projects. The linear regression line for average household income remains relatively flat, hovering around \$100,000. This suggests that budget allocations for Growth-Related projects are not significantly influenced by income levels, indicating a more uniform distribution of funds across wards regardless of household income. A similar lack of correlation is observed in [@fig-state-of-good-repair-budget], where budget allocations for State of Good Repair projects also show minimal dependence on average household income.

In contrast, the linear regression line for population shows a positive correlation with budget allocation for Growth-Related projects. Wards with higher population densities—such as Ward 10 (Spadina-Fort York), Ward 13 (Toronto Centre), Ward 5 (York South-Weston), and Ward 2 (Etobicoke North)—receive a larger share of the Growth-Related budget. This indicates that population density plays a critical role in determining funding levels for these projects, with more populous wards benefiting from increased allocations. A similar trend is observed in the budget distribution for State of Good Repair projects, where wards with higher population densities receive a proportionally larger share of the funds.

### Relationship between Average Household Income & Population with Budget Allocation for Service Improvement and Enhancement Projects 
```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-service-improvement-budget
#| fig.cap: "Service Improvement and Enhancement Budget by Ward"
#| fig-pos: "h"
#| fig.width: 10
#| fig.height: 5

s_i_budget <- combined_data |>
  select(ward_id, ward, population, average_household_income, `Service Improvement and Enhancement`)

p1 <- ggplot(s_i_budget, aes(x = population, y = `Service Improvement and Enhancement`, label= ward_id)) +
  geom_point() +
  geom_text_repel(hjust = -0.5, vjust = 0.5) +
  geom_smooth(method = "lm", color = "blue", se = TRUE) +
  labs(x = "Population", y = "Average Total 10-Year Budget (in 000s) 2021-24") +
  theme_minimal()

p2 <- ggplot(s_i_budget, aes(x = average_household_income, y = `Service Improvement and Enhancement`, label= ward_id)) +
  geom_point() +
  geom_text_repel(hjust = -0.5, vjust = 0.5) +
  geom_smooth(method = "lm", color = "blue", se = TRUE) +
  labs(x = "Average Household Income", y = "") +
  theme_minimal()

# Combine both plots side by side
grid.arrange(p1, p2, ncol = 2)
```
[@fig-service-improvement-budget] illustrates the relationship between average household income, population, and the total 10-year budget allocation for Service Improvement and Enhancement projects. These projects  aim to enhance the quality of services provided to residents and improve the overall infrastructure of the city [@toronto_improvements].

Unlike Growth-Related and State of Good Repair projects, the linear regression lines for average household income and population shows a positive correlation with budget allocation for Service Improvement and Enhancement projects. Wards with higher average household incomes, such as Ward 11 (University-Rosedale) and Ward 13 (Toronto Centre), receive a larger share of the budget allocation for these projects. This suggests that higher-income areas are prioritized for service improvements and infrastructure enhancements, reflecting a targeted approach to resource allocation based on income levels.

Other wards like Ward 3 (Etobicoke-Lakeshore) and Ward 10 (Spadina-Fort York), which have high population densities, also received significant budget allocations, suggesting that these areas are priorities for service improvements and infrastructure enhancement. 

Despite these outliers, the majority of wards received similar budget allocations for Service Improvement and Enhancement projects, underscoring a city-wide strategy to enhance services uniformly for all residents.

# Model {#sec-model}

The purpose of this paper is to investigate the relationship between population density, average household income, and budget allocations across Toronto's 25 wards, and their potential impact on the economic well-being of each ward, as represented by the `total_building_permits` issued. To achieve this, we will first plot the data to visualize the relationships between these variables and the number of building permits issued in each ward independently. Then we will fit a Bayesian regression model with varying intercepts to estimate the effect of these variables on the number of building permits issued in each ward.

## Model set-up

The particular model we used is Bayesian multiple linear regression model with varying intercepts. The model includes the following variables:

\begin{align*} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \beta_0 + \beta_1 x_{\text{population}} + \beta_2 x_{\text{income}} + \beta_3 x_{\text{budget}} + \gamma_i \\
\beta_0 &\sim \mbox{Normal}(0, 2.5) \\
\beta_1 &\sim \mbox{Normal}(0, 2.5) \\
\beta_2 &\sim \mbox{Normal}(0, 2.5) \\
\beta_3 &\sim \mbox{Normal}(0, 2.5) \\
\gamma_i &\sim \mbox{Normal}(0, 2.5) \\
\sigma &\sim \mbox{Exponential}(1)
\end{align*}

In the above model:

- $\mu_i$ is the expected number of building permits issued in ward $i$.
- $\beta_0$ is the intercept, representing the expected number of building permits issued in a ward with average values for all other variables.
- $\beta_1$ is the coefficient for the predicted change in the number of building permits issued in a ward given a one unit increase in the population density of the ward.
- $\beta_2$ is the coefficient for the predicted change in the number of building permits issued in a ward given a one unit increase in the average household income of the ward.
- $\beta_3$ is the coefficient for the predicted change in the number of building permits issued in a ward given a one unit increase in the total budget allocation across three categories: Growth Related, State of Good Repair, and Service Improvement and Enhancement.

The model also includes a varying intercept $\gamma_i$ for each ward, accounting for the unobserved heterogeneity between wards. The varying intercepts allow the model to capture the unique characteristics of each ward that may influence the number of building permits issued.

The model was fitted using the `stan_glmer` function from the `rstanarm` package [@citerstanarm] in R [@citeR]. The prior distributions for the coefficients were set to normal distributions with a mean of 0 and a standard deviation of 2.5. The model also included a prior for the intercept, which was set to a normal distribution with a mean of 0 and a standard deviation of 2.5. The standard deviation of the likelihood was set to an exponential distribution with a rate parameter of 1.

## Model justification



The above factors were choosen as they are known to influence the number of building permits issued in each ward. Population density and average household income are key demographic and economic indicators that can impact construction activity and development. Budget allocations for Growth-Related, State of Good Repair, and Service Improvement and Enhancement projects are critical determinants of infrastructure development and resource distribution. By incorporating these variables into the model, we can assess their individual and combined effects on the number of building permits issued in each ward.


A priori, we expect that population density and average household income will have a positive effect on the number of building permits issued, reflecting the demand for construction and development in densely populated and affluent areas. Similarly, we anticipate that budget allocations for Growth-Related, State of Good Repair, and Service Improvement and Enhancement projects will positively influence the number of building permits, reflecting the city's investment in infrastructure development and maintenance.

```{r}
#| warning: false
#| message: false
#| echo: false
#| label: fig-causal-model
#| fig-cap: "Causal model for the relationship between population, income, and budget allocations"
#| fig-pos: "h"

# create a dag for the model
causal_model <- "digraph {
  graph []
  # Nodes
  node [shape = plaintext]
    A [label = 'Population']
    B [label = 'Budget Allocation']
    C [label = 'Active Construction Projects']
    D [label = 'Income']
{ rank = same A D; }
  # Edges for confounding variable
  edge []
    A -> {B C}
    D -> {B C}
    B -> C
}"

# render the causal model
exporting_image <- grViz(causal_model) |>
  export_svg() |>
  charToRaw() |>
  rsvg_png(here::here("other/sketches/causal_model.png"), width = 800, height = 600)

image <- readPNG(here::here("other/sketches/causal_model.png"))
par(mar = rep(2, 4))
plot.new()
rasterImage(image, 0, 0, 1, 1)  
```

# Results {#sec-results}

In this section, we visualize the relationships between population density, average household income, budget allocations with total number of building permits across Toronto's 25 wards. Additionally, we present our model results, highlighting how these variables influence the number of building permits issued in each ward.

## Relationship between Building Permits and Population, Income, and Budget Allocations

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-building-permits-relationship
#| fig.cap: "Relationship between Variables and Total Building Permits"
#| fig-subcap: ["Population", "Average Household Income", "Total Budget in Three Categories"]
#| fig-pos: "h"
#| layout-ncol: 2

results_data <-
  analysis_budget_data |>
  group_by(ward_id, ward, category) |>
  summarise(total_10_year = mean(total_10_year)) |>
  pivot_wider(names_from = category, values_from = total_10_year) |>
  select(ward_id, ward, `Growth Related`, `State of Good Repair`, `Service Improvement and Enhancement`) |>
  left_join(analysis_building_permits, by = "ward_id") |>
  left_join(analysis_ward_data, by = "ward_id") |>
  rename(ward = ward.x) |>
  select(ward_id, ward, population, average_household_income, total_building_permits, `Growth Related`, `State of Good Repair`, `Service Improvement and Enhancement`) |>
  # add a new column for total budget across three categories
  mutate(total_budget = `Growth Related` + `State of Good Repair` + `Service Improvement and Enhancement`) |>
  select(-`Growth Related`, -`State of Good Repair`, -`Service Improvement and Enhancement`)


# Create multiple scatter plots
plot1 <- ggplot(results_data, aes(x = population, y = total_building_permits, label = ward_id)) +
    geom_point(color = "blue") +
    geom_text_repel(hjust = -0.5, vjust = 0.5) +
    geom_smooth(method = "lm", color = "red", se = TRUE) +
    labs(x = "Population", y = "Total Building Permits")

plot2 <- ggplot(results_data, aes(x = average_household_income, y = total_building_permits, label = ward_id)) +
    geom_point(color = "blue") +
    geom_text_repel(hjust = -0.5, vjust = 0.5) +
    geom_smooth(method = "lm", color = "red", se = TRUE) +
    labs(x = "Average Household Income", y = "Total Building Permits")

plot3 <-
  ggplot(results_data, aes(x = total_budget, y = total_building_permits, label = ward_id)) +
    geom_point(color = "blue") +
    geom_text_repel(hjust = -0.5, vjust = 0.5) +
    geom_smooth(method = "lm", color = "red", se = TRUE) +
    labs(
      x = "Total Budget in Three Categories (Sum)",
      y = "Total Building Permits",
    )

plot1
plot2
plot3
```

We now explore the results of independent comparisons between the outcome variable (total number of building permits in Toronto's 25 wards) and the predictor variables (population density, average household income, and budget allocations for Growth-Related, State of Good Repair, and Service Improvement and Enhancement projects). As shown in [@fig-building-permits-relationship], most predictor variables exhibit relatively flat linear regression lines, indicating a weak relationship with the total number of building permits. 

For example, the relationship between population density and building permits is notably flat, suggesting that population density has minimal influence on construction activity and development across the city’s wards—an unexpected result. A similar trend is observed for Growth-Related and State of Good Repair budget allocations, where flat regression lines suggest a weak relationship. This appears contradictory to earlier findings, where higher population density corresponded to increased budget allocations for these categories, which are typically associated with infrastructure development and maintenance. The same weak correlation is seen for Service Improvement and Enhancement budget allocations, as indicated by the flat regression line.

In contrast, the relationship between average household income and building permits shows a strong positive correlation. Higher-income areas tend to experience more construction activity and development. For instance, Ward 15 (Don Valley West) has the highest number of building permits, aligning with its high average household income. This suggests that higher-income areas are more likely to see increased construction and development, highlighting a clear link between income levels and building permits.


## Model Results {#sec-model-results}


# Discussion {#sec-discussion}

## Average Household Income 

# Weaknesses and Limitations {#sec-limitations}

There are number of limitations that neeeds to be addressed in reagrds to the analysis. As we discussed in section @sec-data, the data used in this analysis is based on publicly available datasets from the City of Toronto. While these datasets provide valuable insights into the city's demographics, budget allocations, and building permits, they may not capture the full complexity of the city's infrastructure development and resource distribution. For example, the building permits dataset only includes active permits, which may not fully represent the scope of construction activity in Toronto. Additionally, the budget allocations dataset may not capture all infrastructure projects and expenditures, leading to potential gaps in the analysis.

Additionally, as shown in @sec-appendix, that there are 45 unique statuses assigned to each submitted permit. For this analysis, we just focused on one subset of these statuses. This may not fully capture the complexity of the building permit process and the various stages of construction and development in Toronto. Future analyses could explore additional permit statuses to gain a more comprehensive understanding of construction activity in the city.

One limitation of this study is the lack of detailed data on specific projects within each budget category, which could provide further insights into why certain wards receive more or less funding. Additionally, while this analysis focused on population density and average household income, other factors like infrastructure needs, community priorities, and political considerations likely play a role in budget decisions. Future research should explore these variables to build a more complete picture of how municipal budgets are allocated. 

A potential limitation is regard ot the model. We assumed that the relationship between population density, average household income, and budget allocations is linear, which may not fully capture the complexity of these relationships. We also assumed independence of each ward, which may not hold true in practice due to shared resources, infrastructure projects, and other factors that could influence building permit issuance. Future research could explore more sophisticated modeling techniques to account for these dependencies and non-linear relationships.


# Future Work {#sec-future-work}

This analysis provides a foundation for future research on infrastructure development, resource distribution, and economic well-being in Toronto. Future studies could explore additional factors that influence budget allocations and building permit issuance, such as infrastructure needs, community priorities, and political considerations. By incorporating these variables into the analysis, researchers can gain a more comprehensive understanding of how municipal budgets are allocated and how construction activity is distributed across the city's wards.

In terms of policy recommendations, the city should adopt equity-based budgeting to ensure underfunded, high-density wards receive adequate resources, particularly for essential services like health and safety. Toronto could also implement a baseline funding model for high-need areas and enhance public engagement in the budget process, ensuring that residents of under served wards have a voice in resource allocation. These actions would promote more transparent, balanced, and equitable urban governance.

\newpage

# Appendix {#sec-appendix}

## Data Tables

### Building Permits Status

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: tbl-status-building-permits-data
#| tbl-cap: "Building permit statuses"
#| tbl-pos: H

# Display the unique statuses in the building permits data using kable
building_permits |>
  distinct(STATUS) |>
  kable() |>
  kable_styling(full_width = F, position = "center")

```

## Model Details {#sec-model-details}

# References
